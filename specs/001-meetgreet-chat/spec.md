# Feature Specification: ミーグリ会話記録

**Feature Branch**: `001-meetgreet-chat`
**Created**: 2025-12-30
**Status**: Draft
**Input**: 既存のアイドル管理アプリに、ミーグリ用の自分と相手の会話の記録用画面と保存機能、画像としてのダウンロード機能を追加する。

## Overview

既存のアイドル管理システム（frontend-public）に、ミーグリ（ミート&グリート）での会話を記録・保存・画像エクスポートできる機能を追加する。既存のメンバー情報と連携し、どのメンバーとの会話かを紐付けられるようにする。

### 既存システムとの統合ポイント

- **バックエンド**: 既存の.NET 10 API（`src/`）に会話関連のエンドポイントを追加
- **フロントエンド**: 既存のfrontend-public（顧客向け参照アプリ）に会話記録画面を追加
- **データ**: 既存のMemberエンティティと紐付け可能（任意）
- **ナビゲーション**: 既存のヘッダー/フッターに会話記録へのリンクを追加

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 会話のリアルタイム記録 (Priority: P1)

ミーグリ（ミート&グリート）中または直後に、ファンがアイドルとの会話を素早く記録したい。スマートフォンで片手操作しながら、自分のセリフとアイドルのセリフを交互に入力し、会話の流れを残す。

**Why this priority**: ミーグリは短時間（通常10〜30秒）のため、素早く記録できることが最も重要。記録できなければ他の機能も意味がない。

**Independent Test**: 新規会話を作成し、自分とアイドルのセリフを交互に3〜5件入力できれば価値を提供。

**Acceptance Scenarios**:

1. **Given** ユーザーが会話記録画面を開いている, **When** テキストを入力して「自分」または「相手」を選択して送信ボタンを押す, **Then** 入力したセリフがチャット風に画面に表示される
2. **Given** 会話が記録されている, **When** 追加のセリフを入力する, **Then** 既存の会話に続けて新しいセリフが追加される
3. **Given** 会話記録画面にいる, **When** 話者を切り替える, **Then** ワンタップで「自分」と「相手」を切り替えられる
4. **Given** 会話記録画面にいる, **When** メンバー選択を開く, **Then** 既存のメンバー一覧から相手を選択できる

---

### User Story 2 - 会話の保存と一覧表示 (Priority: P2)

ファンが過去のミーグリ会話を後から振り返りたい。複数のミーグリの会話を保存し、日付やアイドル名で一覧から探せるようにする。

**Why this priority**: 記録した会話が永続化されなければ価値が失われる。一覧表示により過去の思い出を振り返れる。

**Independent Test**: 会話を保存し、アプリを再起動後も一覧から過去の会話を開ける。

**Acceptance Scenarios**:

1. **Given** 会話を記録した, **When** 保存ボタンを押す, **Then** 会話がタイトル（アイドル名・日付）と共にサーバーに保存される
2. **Given** 複数の会話が保存されている, **When** 一覧画面を開く, **Then** 保存した会話がカード形式で日付順に表示される
3. **Given** 一覧画面にいる, **When** 会話カードをタップする, **Then** その会話の詳細（チャット風表示）が開く
4. **Given** 一覧画面にいる, **When** メンバー名でフィルタする, **Then** そのメンバーとの会話のみが表示される

---

### User Story 3 - 会話の画像エクスポート (Priority: P3)

ファンがミーグリの会話をSNSでシェアしたい、または画像として保存して友達に見せたい。会話画面をきれいな画像としてダウンロードできるようにする。

**Why this priority**: SNSシェアは付加価値機能。会話記録と保存が機能してから意味を持つ。

**Independent Test**: 保存済みの会話を画像ファイル（PNG）としてダウンロードできる。

**Acceptance Scenarios**:

1. **Given** 会話詳細画面を開いている, **When** 画像ダウンロードボタンを押す, **Then** 会話がチャット風デザインの画像ファイルとして端末に保存される
2. **Given** 画像をダウンロードした, **When** ダウンロードしたファイルを開く, **Then** メンバー名（画像付き）、日付、会話内容がきれいにレイアウトされている
3. **Given** 長い会話（10件以上のセリフ）がある, **When** 画像をダウンロードする, **Then** すべてのセリフが1枚の画像に収まる

---

### Edge Cases

- 会話が空（セリフ0件）の状態で保存しようとした場合 → 保存不可のメッセージを表示
- 非常に長いセリフ（500文字以上）を入力した場合 → 入力可能だが画像エクスポート時に適切に折り返し
- メンバーを選択せずに会話を保存した場合 → 「不明なメンバー」として保存可能
- 同一メンバーとの複数回のミーグリ会話がある場合 → 日付と時刻で区別して一覧に表示
- 選択したメンバーが後から削除された場合 → 会話は残り、メンバー名のみ表示（リンク切れ）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: ユーザーはテキストメッセージを入力し、話者（自分/相手）を指定して会話に追加できなければならない
- **FR-002**: 会話はチャットアプリ風のバブルUIで表示されなければならない（自分のセリフは右寄せ、相手のセリフは左寄せ）
- **FR-003**: ユーザーはワンタップで話者（自分/相手）を切り替えられなければならない
- **FR-004**: 相手のメンバーは既存のメンバー一覧から選択できなければならない（任意、未選択も可）
- **FR-005**: 会話にはタイトルを設定できなければならない（デフォルトはメンバー名+日付）
- **FR-006**: ユーザーは会話をサーバーに保存し、後から一覧で確認できなければならない
- **FR-007**: 保存済み会話一覧はカード形式で表示され、タイトル・メンバー画像・日付・プレビューが見えなければならない
- **FR-008**: ユーザーは保存済み会話を削除できなければならない
- **FR-009**: ユーザーは会話を画像ファイル（PNG形式）としてダウンロードできなければならない
- **FR-010**: エクスポートされた画像にはメンバー画像（選択時）、会話タイトル、日付、すべてのセリフがチャット風レイアウトで含まれなければならない
- **FR-011**: 会話記録画面はスマートフォンでの片手操作に最適化されていなければならない
- **FR-012**: 会話一覧はメンバー名でフィルタリングできなければならない

### Key Entities

- **MeetGreetConversation（ミーグリ会話）**: 1回のミーグリでの会話全体。タイトル、対象メンバー（既存Memberへの参照、任意）、日時、複数のメッセージを含む
- **ConversationMessage（会話メッセージ）**: 1つのセリフ。話者種別（自分/相手）、テキスト内容、入力順序を含む
- **Member（メンバー）**: 既存エンティティ。会話の相手として紐付け可能

### API Endpoints（既存APIへの追加）

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/conversations | 会話一覧取得（メンバーIDでフィルタ可） |
| GET | /api/conversations/{id} | 会話詳細取得（メッセージ含む） |
| POST | /api/conversations | 会話新規作成 |
| PUT | /api/conversations/{id} | 会話更新 |
| DELETE | /api/conversations/{id} | 会話削除 |
| POST | /api/conversations/{id}/messages | メッセージ追加 |

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは会話記録画面を開いてから最初のセリフを入力するまで10秒以内に完了できる
- **SC-002**: 話者の切り替えはワンタップ（1アクション）で完了する
- **SC-003**: 5件のセリフを含む会話の記録から保存まで30秒以内に完了できる
- **SC-004**: 保存した会話は一覧画面で3秒以内に表示される
- **SC-005**: 画像エクスポートは5秒以内に完了し、端末のダウンロードフォルダに保存される
- **SC-006**: エクスポートされた画像はSNS投稿に適したサイズ（幅1080px程度）で出力される

## Assumptions

- 既存のアイドル管理APIとfrontend-publicに統合する
- 会話データはサーバーサイド（SQLite）に保存（既存のDBに新テーブル追加）
- 画像エクスポートはクライアントサイド（html2canvas等）で実行
- ユーザー認証は既存システムに合わせる（現状なしの場合は全ユーザー共有）
- 既存のfrontend-publicのデザインシステム（Tailwind CSS、Framer Motion）を踏襲
